<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Transtopia-alpha | 消息 </title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.6 -->
  <link rel="stylesheet" href="plugins/bootstrap-3.3.6/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="plugins/font-awesome-4.7.0/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="plugins/ionicons-2.0.1/css/ionicons.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="plugins/AdminLTE-2.3.11/css/AdminLTE.min.css">
  <link rel="stylesheet" href="plugins/AdminLTE-2.3.11/css/skins/skin-purple.min.css">
	<!-- FileInput -->
	<link href="plugins/bootstrap-fileinput/css/fileinput.css" media="all" rel="stylesheet" type="text/css"/>
	<link href="plugins/bootstrap-fileinput/themes/explorer/theme.css" media="all" rel="stylesheet" type="text/css"/>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body class="skin-purple sidebar-mini">
<div class="wrapper">
  <!-- Main Header -->
  <header class="main-header">
    <!-- Logo -->
    <a href="#" class="logo">
	  <!-- mini logo for sidebar mini 50x50 pixels -->
      <span class="logo-mini"><b>T</b></span>
      <!-- logo for regular state and mobile devices -->
      <span class="logo-lg"><b>Transtopia</b></span>
    </a>

    <!-- Header Navbar -->
    <nav class="navbar navbar-default" role="navigation">
      <!-- Sidebar toggle button-->
      <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button"></a>
			<!-- Navbar Left Menu -->
				<!-- fill it here -->
			<!-- /.Navbar Left Menu -->
			
			<!-- Navbar Right Menu -->
				<!-- fill it here -->
			<!-- /.Navbar Right Menu -->
    </nav>
  </header>
	
  <!-- Left side column. contains the logo and sidebar -->
  <aside class="main-sidebar">
    <!-- sidebar: style can be found in sidebar.less -->
    <section class="sidebar">
			<form action="#" method="get" class="sidebar-form">
				<div class="input-group">
					<input type="text" name="q" class="form-control" placeholder="Search...">
						<span class="input-group-btn">
							<button type="submit" name="search" id="search-btn" class="btn btn-flat"><i class="fa fa-search"></i>
							</button>
						</span>
				</div>
			</form>
			<ul class="sidebar-menu">
				<!-- Optionally, you can add icons to the links -->
				<li><a href="#tab_moment" data-toggle="tab"><i class="fa fa-list-alt"></i> <span>全部动态</span></a></li>
				<li><a href="#tab_moment" data-toggle="tab" data-filter='{"star": 1}'><i class="fa fa-list-alt"></i> <span>星标动态</span></a></li>
				<li><a href="#tab_customerhome" data-toggle="tab"><i class="fa fa-list-alt"></i> <span>个人动态</span></a></li>
				<li class="header">联系人动态</li>
				<li><a href="#tab_moment" data-toggle="tab" data-filter='{"friend": 1}'><i class="fa fa-list-alt"></i> <span>好友动态</span></a></li>
				<li><a href="#tab_moment" data-toggle="tab" data-filter='{"group": 1}'><i class="fa fa-list-alt"></i> <span>群组动态</span></a></li>
			</ul>
    </section>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
		<section class="content-header">
      <h1>
        <i class="fa fa-dashboard"></i> 动态
      </h1>
      <ol class="breadcrumb">
        <li><a href="#newpost" data-toggle="modal" class="btn btn-default"><i class="fa fa-plus"></i> 发布新动态</a></li>
      </ol>
    </section>
		<!-- Main content -->
    <section class="content">
			<div class="tab-content">
				<!-- 动态页面Layout -->
				<div id="tab_moment" class="tab-pane container-fluid">
					<div class="timeline moment-content">
						
					</div>
				</div>
				<!-- 动态页面Layout -->
				<!-- 个人页面 Layout -->
				<div id="tab_customerhome" class="tab-pane container">
					<!-- 用户信息 -->
					<div id="userInfo">
						<div class="box box-widget widget-user">
							<!-- Add the bg color to the header using any of the bg-* classes -->
							<div data-type="bg" class="widget-user-header bg-black">
								<!-- <h3 class="widget-user-username"></h3> -->
								<!-- <h5 class="widget-user-desc">软件工程师</h5> -->
							</div>
							<div class="widget-user-image" style="top: 100px; left: 0; margin-left: 15px;">
								<img data-type="img" class="img-thumbnail" style="border">
							</div>
							<div class="box-footer" style="padding-top: 10px;">
								<div class="row" style="margin-left: 120px;">
									<span data-type="name" style="font-size: 20px;"></span>
									<span data-type="title" class="" style="margin-left: 10px;"></span>
									<span style="margin-left: 10px;">
										<a href="#" class="btn btn-primary btn-xs" data-type="follow"><b><i class="fa fa-plus"></i> 关注</b></a>
									</span>
									<div>
										<strong><i class="fa fa-book margin-r-5"></i> 个人介绍</strong>
										<p data-type="introduction">
											<!-- 个人简介 -->
										</p>

										<strong><i class="fa fa-pencil margin-r-5"></i> 父话题</strong>

										<p data-type="topic-genres">
											
										</p>

										<strong><i class="fa fa-file-text-o margin-r-5"></i> 子话题</strong>
										
										<p data-type="topic-tags">
										 
										</p>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<!-- /.用户信息 -->
					<!-- 动态框 -->
					<div class="nav-tabs-custom">
						<!-- tab -->
						<ul class="nav nav-tabs">
							<li><a href="#tab_1" data-toggle="tab">动态 <span data-type="moment-count" style="color: #bdbdbd"> 4</span></a></li>
							<li class="dropdown">
								<a class="dropdown-toggle" data-toggle="dropdown" href="#">
									关注 <span class="caret"></span>
								</a>
								<ul class="dropdown-menu">
									<li><a href="#tab_2" data-toggle="tab" data-type="following" data-filter='{"individual": 1}'>关注的人 <span data-type="following-individual" style="color: #bdbdbd"> 4</span></a></li>
									<li><a href="#tab_2" data-toggle="tab" data-type="following"  data-filter='{"group": 1}'>关注的群组 <span data-type="following-group" style="color: #bdbdbd"> 4</span></a></li>
									<li class="divider"></li>
									<li><a href="#tab_2" data-toggle="tab" data-type="followed">关注我的人 <span data-type="followed-by" style="color: #bdbdbd"> 4</span></a></li>
								</ul>
							</li>
						</ul>
						<!-- /. tab -->
						<!-- tab-content -->
						<div class="tab-content">
							<div class="tab-pane" id="tab_1">
								<ul class="timeline">
								
								</ul>
							</div>
							<div class="tab-pane" id="tab_2">
								<!-- 用户信息 -->
							</div>
						</div>
						<!-- /. tab-content -->
					</div>
					<!-- /. 动态框 -->
				</div>
				<!-- /. 个人页面Layout -->
			</div>
			
			<!-- modal 开始 -->
			<div class="modal fade" id="momentModal" tabindex="-1">
				<div class="modal-dialog" style="width: 60%;">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
								&times;
							</button>
							<h4 class="modal-title">
								<!-- 用户信息 -->
							</h4>
						</div>
						<div class="modal-body">
							<h4 class="moment-title">
							<!-- 标题 -->
							</h4>
							<h6 class="moment-datetime">
							<!-- 时间 -->
							</h6>
							<div class="content">
							<!-- 内容 -->
							</div>
							<div class="clearfix" style="float: right;">
								<a class="btn btn-default btn-xs" style="margin-left: 5px;"><span class="fa fa-tag"></span> 分享</a>
								<a class="btn btn-default btn-xs" style="margin-left: 5px;"><span class="fa fa-tag"></span> 举报</a>
							</div>
							<div class="tags">
								<!-- 标签 -->
							</div>
						</div>
					</div><!-- /.modal-content -->
				</div><!-- /.modal -->
			</div>
			
			<div class="modal fade" id="newpost" tabindex="-1">
				<div class="modal-dialog" style="width: 60%;">
					<div class="modal-content">
						<div class="modal-header">
							<button type="button" class="close" data-dismiss="modal" aria-hidden="true">
								&times;
							</button>
							<h4 class="modal-title">
								发布新动态
							</h4>
						</div>
						<div class="modal-body">
							<div id="postmoment" class="box-body">
								<div class="form-group">
									<label>标题</label>
									<input id="moment-title" class="form-control">
								</div>
								<div id="moment-content">
									<div class="btn-toolbar" data-role="editor-toolbar" data-target="#editor">
										<div class="btn-group">
										<a class="btn dropdown-toggle" data-toggle="dropdown" title="字体"><i class="icon-font"></i><b class="caret"></b></a>
											<ul class="dropdown-menu">
											</ul>
										</div>
										<div class="btn-group">
										<a class="btn dropdown-toggle" data-toggle="dropdown" title="字体大小"><i class="icon-text-height"></i>&nbsp;<b class="caret"></b></a>
											<ul class="dropdown-menu">
											<li><a data-edit="fontSize 5"><font size="5">大</font></a></li>
											<li><a data-edit="fontSize 3"><font size="3">中</font></a></li>
											<li><a data-edit="fontSize 1"><font size="1">小</font></a></li>
											</ul>
										</div>
										<div class="btn-group">
										<a class="btn" data-edit="bold" title="加粗 (Ctrl/Cmd+B)"><i class="icon-bold"></i></a>
										<a class="btn" data-edit="italic" title="斜体 (Ctrl/Cmd+I)"><i class="icon-italic"></i></a>
										<a class="btn" data-edit="strikethrough" title="（加） 删除线"><i class="icon-strikethrough"></i></a>
										<a class="btn" data-edit="underline" title="下划线 (Ctrl/Cmd+U)"><i class="icon-underline"></i></a>
										</div>
										<div class="btn-group">
										<a class="btn" data-edit="insertunorderedlist" title="项目列表"><i class="icon-list-ul"></i></a>
										<a class="btn" data-edit="insertorderedlist" title="数字列表"><i class="icon-list-ol"></i></a>
										<a class="btn" data-edit="outdent" title="清除缩进 (Shift+Tab)"><i class="icon-indent-left"></i></a>
										<a class="btn" data-edit="indent" title="缩进 (Tab)"><i class="icon-indent-right"></i></a>
										</div>
										<div class="btn-group">
										<a class="btn" data-edit="justifyleft" title="居左 (Ctrl/Cmd+L)"><i class="icon-align-left"></i></a>
										<a class="btn" data-edit="justifycenter" title="居中 (Ctrl/Cmd+E)"><i class="icon-align-center"></i></a>
										<a class="btn" data-edit="justifyright" title="居右 (Ctrl/Cmd+R)"><i class="icon-align-right"></i></a>
										<a class="btn" data-edit="justifyfull" title="正常 (Ctrl/Cmd+J)"><i class="icon-align-justify"></i></a>
										</div>
										<div class="btn-group">
											<a class="btn dropdown-toggle" data-toggle="dropdown" title="超链接"><i class="icon-link"></i></a>
											<div class="dropdown-menu input-append">
												<input class="span2" placeholder="URL" type="text" data-edit="createLink"/>
												<button class="btn" type="button">添加</button>
										</div>
										<a class="btn" data-edit="unlink" title="去除链接"><i class="icon-cut"></i></a>
										</div>
										<div class="btn-group">
										<a class="btn" title="浏览或拖拽添加图片" id="pictureBtn"><i class="icon-picture"></i></a>
										<input type="file" data-role="magic-overlay" data-target="#pictureBtn" data-edit="insertImage" />
										</div>
										<div class="btn-group">
										<a class="btn" data-edit="undo" title="撤消 (Ctrl/Cmd+Z)"><i class="icon-undo"></i></a>
										<a class="btn" data-edit="redo" title="重复 (Ctrl/Cmd+Y)"><i class="icon-repeat"></i></a>
										</div>
									</div>
									<div id="editor" class="editor"></div>
								</div>
								<!-- 更多选项 -->
								<div id="collapse-moment_option" class="timeline-footer panel-collapse collapse" style="">
									<div class="form-group">
									<label>发布者</label>
										<select id="select-sender" class="form-control" style="width: 100%;">
										</select>
									</div>
									<div class="form-group">
										<label>分类</label>
										<select id="select-genre" class="form-control" style="width: 100%;">
										</select>
									</div>
									<div >
										<label>标签</label>
										<select id="select-tags" class="form-control" multiple="multiple" data-placeholder="请选择标签" style="width: 100%;">
										</select>
									</div>
									<div>
										<label>分享范围</label>
										<select id="select-sharedwith" class="form-control" multiple="multiple" data-placeholder="请选择分享范围" style="width: 100%;">
										</select>
									</div>
								</div>
								<div class="clearfix" style="margin-top:5px;">
									<a data-toggle="collapse" href="#collapse-moment_option"><i class="fa fa-plus"></i> 更多选项</a>
									<a id="shareMoment-btn" class="btn btn-primary btn-flat btn-xs pull-right">分享</a>
								</div>
							</div>
						</div>
					</div><!-- /.modal-content -->
				</div><!-- /.modal -->
			</div>
    </section>
    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->


	
	
	
  <!-- Main Footer -->
  <footer class="main-footer">
    <!-- To the right -->
    <div class="pull-right hidden-xs">
      <!-- Anything you want -->
    </div>
    <!-- Default to the left -->
    <strong>Copyright &copy; 2017 <a href="#">Transtopia</a>.</strong> All rights reserved.
  </footer>

  <!-- Control Sidebar -->
</div>
<!-- ./wrapper -->


<!-- REQUIRED JS SCRIPTS -->
<!-- jQuery 2.2.3 -->
<script src="plugins/jQuery/jquery-2.2.3.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="plugins/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<!-- AdminLTE App -->
<script src="plugins/AdminLTE-2.3.11/js/app.min.js"></script>
<!-- Slimscroll -->
<script src="plugins/slimScroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="plugins/fastclick/fastclick.min.js"></script>
<!-- FileInput -->
<script src="plugins/bootstrap-fileinput/js/plugins/sortable.js" type="text/javascript"></script>
<script src="plugins/bootstrap-fileinput/js/fileinput.js" type="text/javascript"></script>
<script src="plugins/bootstrap-fileinput/themes/explorer/theme.js" type="text/javascript"></script>
<script src="plugins/bootstrap-fileinput/js/locales/zh.js" type="text/javascript"></script>
<!-- Select2 -->
<script src="plugins/select2/select2.min.js" type="text/javascript"></script>
<link href="plugins/select2/select2.min.css" rel="stylesheet" />
<!-- bootstrap-wysiwyg -->
<link href="plugins/bootstrap-wysiwyg/external/google-code-prettify/prettify.css" rel="stylesheet">
<!-- <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.no-icons.min.css" rel="stylesheet">
<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css" rel="stylesheet"> -->
<link href="http://netdna.bootstrapcdn.com/font-awesome/3.0.2/css/font-awesome.css" rel="stylesheet">
<!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script> -->
<script src="plugins/bootstrap-wysiwyg/external/jquery.hotkeys.js"></script>
<!-- <script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script> -->
<script src="plugins/bootstrap-wysiwyg/external/google-code-prettify/prettify.js"></script>
<script src="plugins/bootstrap-wysiwyg/bootstrap-wysiwyg.js"></script>




<!-- 我的JS和CSS -->
<script>
//写给老付
/*
post = [{
	id: ,
	user_id: ,
	user_name: ,
	user_img:,
	user_followers: , //关注者总人数
	user_blogs: , //发表总文章数
	user_bestblogs: , //用户精华帖
	
	title: , //标题
	content: , //内容
	datetime: , //时间
	genre: , // 大分类
	tags: [], // 小标签
	sharedwith: [], //分享范围，是否需要？？？
	total_like: , //总点赞人数
	like: (0 or 1), //我是否点赞
	star: (0 or 1), //我是否加星
	
	comments: [{
		user_id: ,
		user_name: ,
		user_img:,
		
		to_id: , //回复用户id
		to_name: , //回复用户姓名
		content: , //内容
		datetime:  //时间
	}] // 评论
}];
*/
var ACTION_MAP = {
	//新增
	getRelatedMoment: 'getrelatedmoment', //获取用户相关动态，其中包好一个{filter}
	getUserInfobyID: 'getuserinfobyid', //通过ID获取用户资料
	getMomentByUserID: 'getmomentbyuserid', //获取摸一个用户的动态列表
	getFollowing: 'getfollowing', //获取关注的人和群
	getFollowed: 'getfollowed', //获取关注的人和群
	
	getMomentByID: 'getmomentbyid', //通告id获取一条动态 || input: {moment_id} || output: post
	
	getFollowedMoment: 'getFollowedMoment?uid=', //获取摸一个用户follow的动态列表
	getOption: 'getOption?uid=', //获取静态的参数，发布新动态时候的OPTION
	postMoment: 'postMoment?uid=', //发送动态
	postReplyToMoment: 'postReplyToMoment?uid=', //回复动态
	starMoment: 'starMoment?uid=', //星标或取消
	likeMoment: 'likeMoment?uid=', //喜欢或取消
	removeTagOfMoment: 'removeTagOfMoment?uid=', //移除tag
	
	follow: 'follow', //关注或取消
	getContactInfo: 'getcontactinfo' //获取用户好友和组列表
};
//PS: 上述都需要你添加当前用户的ID
</script>

<script>
//加载动态发布框
var initialMomentPostBlock = function(target){
	loadWysiwyg(target + ' #editor');
	$('#shareMoment-btn').click(function(){
		var moment = {};
		moment['content'] = $(target + ' #editor').html();
		moment['title'] = $(target + ' #moment-title').val();
		moment['sender'] = $(target + ' #select-sender').val();
		moment['genre'] = $(target + ' #select-genre').val();
		moment['tags'] = $(target + ' #select-tags').val();
		moment['sharedwith'] = $(target + ' #select-sharedwith').val();
		
		console.log(moment['content']);
		
		$.post(ACTION_MAP.postMoment, moment ,function(data) {
			//console.log(data);
			//loadMoment(data, '#allMoments');
			//location.reload();
		})
		.fail(function() {
			console.log('Err: post moment')
		});
		//console.log(data)
	});
	//加载更多选项
	$.get( ACTION_MAP.getOption, function(data) {
		//console.log(data);
		//加载类型和tag
		$("#select-genre").select2({
			data: data.genres
		});
		$("#select-tags").select2({
			data: data.tags
		});
		$("#select-sender").select2({
			data: data.senders
		});
		$("#select-sharedwith").select2({
			data: data.sharedwith
		});
	})
  .fail(function() {
    console.log('Err: option')
  });
};


//加载动态
var loadMoment = function(data, loadto){
	//all data must be sort by date in desending order
	var pre_date = "";
	$.each(data,function(index, moment){
		var date = getDate_Trans(moment.datetime);
		if(date != pre_date){
			pre_date = date;
			$(loadto).append(
				'<li class="time-label">\
						<span class="bg-red">\
						' + pre_date + '\
						</span>\
				</li>'
			);
		}
		// data-toggle="modal" data-target="#momentModal
		
		//$('#collapse-tag-' + moment.id).remove();
		//$('#collapse-review-' + moment.id).remove();
		//加载基本信息
		//<div class="moment moment-fold" data-id="' + moment.id + '">' + moment.content + '</div>
		//判断动态简略图
		var content_brief = '';
		if($(moment.content).find('img').length != 0)
			content_brief = '<div class="row">\
												<div class="col-lg-2"><img class="img-thumbnail" src="' + $(moment.content).find('img:eq(1)').attr('src') + '"></div>\
												<div class="col-lg-10 moment moment-fold" data-id="' + moment.id + '">' + moment.content + '</div>\
											</div>';
		else
			content_brief = '<div class="moment moment-fold" data-id="' + moment.id + '">' + moment.content + '</div>';
			
		$(loadto).append(
			'<li class="moment-item" data-id="' + moment.id + '">\
				<img class="img-circle img-bordered-sm timeline-moment-img" src="' + moment.user_img + '" style="width: 30px;height: 30px;font-size: 15px;line-height: 30px;position: absolute;color: #666;background: #d2d6de;border-radius: 50%;text-align: center;left: 18px;top: 0;">\
				<div class="timeline-item timeline-moment">\
					<span class="time"><i class="fa fa-clock-o"></i> ' + getTime_Trans(moment.datetime) + ' </span>\
					<h3 class="timeline-header"><a href="#tab_customerhome" data-toggle="tab" data-uid="' + moment.user_id + '" >' + moment.user_name + '</a> <small><span class="fa fa-chevron-right"></span> <a href="#">' + moment.genre + '</a></small></h3>\
					<div class="timeline-body">\
						<h3><a href="javascript:void(0);" class="moment-title" data-id="' + moment.id + '">' + moment.title + '</a></h3>\
						' + content_brief + '\
					</div>\
					<div class="timeline-footer clearfix" >\
						<a href="javascript:void(0)" class="pull-right moment-star" style="margin-right:15px;" data-id="' + moment.id + '" data-star="' + moment.star + '"><span class="fa ' + (moment.star==0 ? "fa-star-o" : "fa-star") + '"></span></a>\
						<a href="javascript:void(0)" class="pull-right moment-like" style="margin-right:15px;" data-id="' + moment.id + '" data-like="' + moment.like + '"><span class="fa ' + (moment.like==0 ? "fa-thumbs-o-up" : "fa-thumbs-up") + '"></span> ' + moment.total_like + '</a>\
						<a class="pull-right" style="margin-right:15px;" data-toggle="collapse" href="#collapse-tag-' + moment.id + '"><span class="fa fa-tag"></span> ' + $(moment.tags).length + '</a>\
						<a class="pull-right" style="margin-right:15px;" data-toggle="collapse" href="#collapse-review-' + moment.id + '"><span class="fa fa-comment"></span>  ' + $(moment.comments).length + '</a>\
					</div>\
					<div id="collapse-tag-' + moment.id + '" class="timeline-footer panel-collapse collapse">\
						<!-- <a href="javascript:void(0)" class="btn btn-success btn-xs moment-addtag" style="margin-left: 5px;">添加</a> --\>\
					</div>\
					<div id="collapse-review-' + moment.id + '" class="timeline-footer panel-collapse collapse" style="background: #f5f5f5;">\
						<div class="comment-review-item" style="margin: 5px 30px;">\
						</div>\
					</div>\
				</li>'
		);
		
		//加载标签
		$.each(moment.tags,function(index, tag){
			$(loadto +' #collapse-tag-' + moment.id).prepend('<a href="javascript:void(0)" class="btn btn-primary btn-xs moment-tag" style="margin-left: 5px;" data-id="' + moment.id + '" data-tag="' + tag + '"><span class="fa fa-tag"></span> ' + tag + ' &times;</a>');
		});
		//添加编辑框
		appendWysiwygEditor(moment.id, loadto + ' #collapse-review-' + moment.id, 'pre');
		
		//添加回复信息
		$.each(moment.comments,function(index, comment){
			 $(loadto + ' #collapse-review-' + moment.id + ' .comment-review-item').append(
				'<div class="post" style="border-bottom: 1px solid #ddd;">\
					<div class="user-block">\
					<img class="img-circle img-bordered-sm" src="' + comment.user_img + '" alt="user image">\
						<span class="username">\
							<a href="#tab_customerhome" data-toggle="tab" data-uid="' + comment.user_id + '" >' + comment.user_name + '</a>\
							\
						</span>\
					<span class="description">' + getDate_Trans(comment.datetime) + ' ' + getTime_Trans(comment.datetime) +'</span>\
					</div>\
					<div class="reply reply-fold">' + comment.content + '</div>\
				</div>'
			 );
			 
		});
		//$(loadto).append(html_text);
		//加载用户的信息弹框
		appendUserPopup(moment, loadto +' .timeline-moment-img');
		
		
	});	
	$(loadto).append('<li><i class="fa fa-clock-o bg-gray"></i>');
	
	
	//回复动态
	$(loadto + ' .replyMoment-btn').click(function(){
		var id = $(this).attr('value');
		var reply = {};
		reply['id'] = id
		reply['content'] = $('#editor-'+id).html();
		//console.log(reply);
		$.post(ACTION_MAP.postReplyToMoment, reply ,function(data) {
			console.log(data);
			//loadMoment(data, '#allMoments');
			//location.reload();
			$(loadto + ' #collapse-review-' + id + ' .comment-review-item').empty();
			$.each(data.comments,function(index, comment){
				 $(loadto + ' #collapse-review-' + id + ' .comment-review-item').append(
					'<div class="post" style="border-bottom: 1px solid #ddd;">\
						<div class="user-block">\
						<img class="img-circle img-bordered-sm" src="' + comment.user_img + '" alt="user image">\
							<span class="username">\
								<a href="#tab_customerhome" data-toggle="tab" data-uid="' + comment.user_id + '" >' + comment.user_name + '</a>\
								\
							</span>\
						<span class="description">' + getDate_Trans(comment.datetime) + ' ' + getTime_Trans(comment.datetime) +'</span>\
						</div>\
						<div class="reply reply-fold">' + comment.content + '</div>\
					</div>'
				 ); 
			});
			
		})
		.fail(function() {
			console.log('Err: reply')
		});
	});
	
	//加载模态框
	$(loadto + ' .moment-item .moment-title').on('click', function(event){
		$.get(ACTION_MAP.getMomentByID, {moment_id: $(this).attr('data-id')}, function(data){
			$('#momentModal h4[class="modal-title"]').html('<div class="user-block"> \
																	<img class="img-circle img-bordered-sm" src="' + data.user_img + '" alt="user image"> \
																		<span class="username"> \
																			<a href="#">' + data.user_name + '</a> \
																			<a href="#" class="btn btn-success btn-sm pull-right follow-btn" style="margin-right: 15px;" value="' + data.user_id + '">关注</a> \
																		</span> \
																	<span class="description" style="display: inline;">发表动态： ' + data.user_blogs + '</span> \
																	<span class="description" style="display: inline;">精华动态： ' + data.user_bestblogs + '</span> \
																	<span class="description" style="display: inline;">关注人数： ' + data.user_followers + '</span> \
																	</div>');
			$('h4[class="moment-title"]').text(data.title);
			//datetime格式要优化
			$('h4[class="moment-datetime"]').text(data.datetime);
			$('#momentModal .modal-body .content').html(data.content);
			$('#momentModal .modal-body .tags').empty();
			$.each(data.tags,function(index, tag){
				$('#momentModal .modal-body .tags').append('<a class="btn btn-primary btn-xs" style="margin-left: 5px;"><span class="fa fa-tag"></span> ' + tag + '</a>');
			});
			console.log(data.followed );
			if(data.followed == '0'){
				$('.modal .follow-btn').remove();
			}else{
				if(data.followed == '1')
					$('.modal .follow-btn').attr('data-follow', 2).text('取消关注');
				else
					$('.modal .follow-btn').attr('data-follow', 1).text('关注');
				$('.follow-btn').on('click', function(){
					$.get(ACTION_MAP.follow, {followed_id: $(this).attr('value'), value: $(this).attr('data-follow')}, function(data){
						//location.reload();
						if($('.modal .follow-btn').attr('data-follow') == 1)
							$('.modal .follow-btn').attr('data-follow', 2).text('取消关注');
						else
							$('.modal .follow-btn').attr('data-follow', 1).text('关注');
					}).fail(function() {
						console.log('Err: follow')
					});
				});
			}
			$('#momentModal').modal('show');
		})
		.fail(function() {
			console.log('Err: modal');
		});
	});

	//加载用户信息popover
	$(loadto + " [data-toggle='popover']").popover();

	//星标
	$(loadto + ' .moment-star').on('click',function(){
		var val = (parseInt($(this).attr('data-star'))+1)%2;
		$(this).find('span').toggleClass('fa-star-o').toggleClass('fa-star');
		$(this).attr('data-star', val);
		$.get(ACTION_MAP.starMoment, {moment_id: $(this).attr('data-id'), star: val}, function(){
			
		})
		.fail(function() {
			console.log('Err: star');
		});
	});
	//喜欢
	$(loadto + ' .moment-like').on('click',function(){
		var val = (parseInt($(this).attr('data-like'))+1)%2;
		$(this).find('span').toggleClass('fa-thumbs-o-up').toggleClass('fa-thumbs-up');
		$(this).attr('data-like', val);
		$.get(ACTION_MAP.likeMoment, {moment_id: $(this).attr('data-id'), like: val}, function(){
			
		})
		.fail(function() {
			console.log('Err: like');
		});
	});
	//取消tag
	$(loadto + ' .moment-tag').on('click',function(){
		$(this).remove();
		$.get(ACTION_MAP.removeTagOfMoment, {moment_id: $(this).attr('data-id'), tag: $(this).attr('data-tag')}, function(){
			
		})
		.fail(function() {
			console.log('Err: tag');
		});
	});
	
	//加载用户跳转
	$(loadto + ' a[data-toggle="tab"][href="#tab_customerhome"]').on('shown.bs.tab', function (e) {
		$.get(ACTION_MAP.getUserInfobyID, {uid: $(this).attr('data-uid')}, function(data){
				loadUserInfo(data, '#tab_customerhome');
			})
			.fail(function() {
				console.log('Err: 用户跳转');
			});
	});
	
};

//用户跳转					
var loadUserInfo = function(data, target){
	$(target+ ' [data-type="bg"]').css({'background': 'url("' + data.bg + '") center center'});
	$(target+ ' [data-type="img"]').attr({'src': data.img});
	$(target+ ' [data-type="name"]').html('<b>' + data.name + '</b>');
	$(target+ ' [data-type="title"]').text(data.title);
	//此处应完善
	$(target+ ' [data-type="follow"]').attr({'data-id': data.id});
	if(data.followed == '0'){
		$(target+ ' [data-type="follow"]').remove();
	}else{
		if(data.followed == '1')
			$(target+ ' [data-type="follow"]').attr('data-follow', 2).text('取消关注');
		else
			$(target+ ' [data-type="follow"]').attr('data-follow', 1).text('关注');
		$(target+ ' [data-type="follow"]').on('click', function(){
			$.get(ACTION_MAP.follow, {followed_id: $(this).attr('data-id'), value: $(this).attr('data-follow')}, function(data){
				//location.reload();
				if($(target+ ' [data-type="follow"]').attr('data-follow') == 1)
					$(target+ ' [data-type="follow"]').attr('data-follow', 2).text('取消关注');
				else
					$(target+ ' [data-type="follow"]').attr('data-follow', 1).text('关注');
			}).fail(function() {
				console.log('Err: follow')
			});
		});
	}
	
	$(target+ ' [data-type="introduction"]').text(data.introduction);
	//此处应完善
	$(target+ ' [data-type="topic-genres"]').empty();
	$.each(data.topic_genres, function(index, genre){
		$(target+ ' [data-type="topic-genres"]').append('<span class="label ' + randomPicker(colors) + '" style="margin-left: 3px;">' + genre + '</span>');
	});
	//此处应完善
	$(target+ ' [data-type="topic-tags"]').empty();
	$.each(data.topic_tags, function(index, tag){
		$(target+ ' [data-type="topic-tags"]').append('<span class="label ' + randomPicker(colors) + '" style="margin-left: 3px;">' + tag + '</span>');
	});
	
	$(target+ ' .nav-tabs-custom').attr({uid: data.id});
	$(target+ ' [data-type="moment-count"]').text(' ' + data.moment_count);
	$(target+ ' [data-type="following-individual"]').text(' ' + data.following_individual);
	$(target+ ' [data-type="following-group"]').text(' ' + data.following_group);
	$(target+ ' [data-type="followed-by"]').text(' ' + data.followed_by);
	
	$(target+ ' .nav-tabs-custom a[data-toggle="tab"]:eq(0)').tab('show');
};

var loadFollowList = function(data, target){
	$(target).empty();
	$.each(data, function(index, user){
		$(target).append(
		'<div class="box box-widget widget-user-2">\
			<div class="widget-user-header">\
				<div class="widget-user-image">\
					<img class="img-circle" src="' + user.img + '" alt="User Avatar">\
				</div>\
				<a href="#" class="btn btn-primary pull-right" data-type="follow" data-id="' + user.id + '" data-follow="' + user.followed + '" style="margin-top:15px;"> 关注</b></a>\
				<h3 class="widget-user-username">' + user.name + '</h3>\
				<h5 class="widget-user-desc">' + user.title + '</h5>\
			</div>\
		</div>'
		);
		if(user.followed == '0'){
			$(target+ ' [data-type="follow"]').last().remove();
		}else{
			if(user.followed == '1')
				$(target+ ' [data-type="follow"]').last().attr('data-follow', 2).text('取消关注');
			else
				$(target+ ' [data-type="follow"]').last().attr('data-follow', 1).text('关注');
		}
	});
	$(target+ ' [data-type="follow"]').on('click', function(){
		if($(this).attr('data-follow') == 1)
			$(this).attr('data-follow', 2).text('取消关注');
		else
			$(this).attr('data-follow', 1).text('关注');
		$.get(ACTION_MAP.follow, {followed_id: $(this).attr('data-id'), value: $(this).attr('data-follow')}, function(data){
			//location.reload();
			
		}).fail(function() {
			console.log('Err: follow')
		});
	});
};

//加载editor
var appendWysiwygEditor = function(id, appendto, location){
	var html = '<div class="btn-toolbar" data-role="editor-toolbar" data-target="#editor-' + id + '">\
								<div class="btn-group">\
								<a class="btn dropdown-toggle" data-toggle="dropdown" title="字体"><i class="icon-font"></i><b class="caret"></b></a>\
									<ul class="dropdown-menu">\
									</ul>\
								</div>\
								<div class="btn-group">\
								<a class="btn dropdown-toggle" data-toggle="dropdown" title="字体大小"><i class="icon-text-height"></i>&nbsp;<b class="caret"></b></a>\
									<ul class="dropdown-menu">\
									<li><a data-edit="fontSize 5"><font size="5">大</font></a></li>\
									<li><a data-edit="fontSize 3"><font size="3">中</font></a></li>\
									<li><a data-edit="fontSize 1"><font size="1">小</font></a></li>\
									</ul>\
								</div>\
								<div class="btn-group">\
								<a class="btn" data-edit="bold" title="加粗 (Ctrl/Cmd+B)"><i class="icon-bold"></i></a>\
								<a class="btn" data-edit="italic" title="斜体 (Ctrl/Cmd+I)"><i class="icon-italic"></i></a>\
								<a class="btn" data-edit="strikethrough" title="（加） 删除线"><i class="icon-strikethrough"></i></a>\
								<a class="btn" data-edit="underline" title="下划线 (Ctrl/Cmd+U)"><i class="icon-underline"></i></a>\
								</div>\
								<div class="btn-group">\
								<a class="btn" data-edit="insertunorderedlist" title="项目列表"><i class="icon-list-ul"></i></a>\
								<a class="btn" data-edit="insertorderedlist" title="数字列表"><i class="icon-list-ol"></i></a>\
								<a class="btn" data-edit="outdent" title="清除缩进 (Shift+Tab)"><i class="icon-indent-left"></i></a>\
								<a class="btn" data-edit="indent" title="缩进 (Tab)"><i class="icon-indent-right"></i></a>\
								</div>\
								<div class="btn-group">\
								<a class="btn" data-edit="justifyleft" title="居左 (Ctrl/Cmd+L)"><i class="icon-align-left"></i></a>\
								<a class="btn" data-edit="justifycenter" title="居中 (Ctrl/Cmd+E)"><i class="icon-align-center"></i></a>\
								<a class="btn" data-edit="justifyright" title="居右 (Ctrl/Cmd+R)"><i class="icon-align-right"></i></a>\
								<a class="btn" data-edit="justifyfull" title="正常 (Ctrl/Cmd+J)"><i class="icon-align-justify"></i></a>\
								</div>\
								<div class="btn-group">\
									<a class="btn dropdown-toggle" data-toggle="dropdown" title="超链接"><i class="icon-link"></i></a>\
									<div class="dropdown-menu input-append">\
										<input class="span2" placeholder="URL" type="text" data-edit="createLink"/>\
										<button class="btn" type="button">添加</button>\
								</div>\
								<a class="btn" data-edit="unlink" title="去除链接"><i class="icon-cut"></i></a>\
								</div>\
								<div class="btn-group">\
								<a class="btn" title="浏览或拖拽添加图片" id="pictureBtn' + id + '"><i class="icon-picture"></i></a>\
								<input type="file" data-role="magic-overlay" data-target="#pictureBtn' + id + '" data-edit="insertImage" />\
								</div>\
								<div class="btn-group">\
								<a class="btn" data-edit="undo" title="撤消 (Ctrl/Cmd+Z)"><i class="icon-undo"></i></a>\
								<a class="btn" data-edit="redo" title="重复 (Ctrl/Cmd+Y)"><i class="icon-repeat"></i></a>\
								</div>\
							</div>\
							<div id="editor-' +id + '" class="editor">\
							</div>\
							<div style="text-align: right; margin-top:5px;"><a class="btn btn-primary btn-flat btn-xs replyMoment-btn" value="' + id + '">回复</a> </div>'
		
	if(location == 'pre')
			$(appendto).prepend(html);
	else
		$(appendto).append(html);
	
	loadWysiwyg('#editor-' +id + '');
};




//加载用户弹框
var appendUserPopup = function(data, appendto){
	$(appendto).attr({
		'data-container': 'body',
		'data-trigger': 'hover', 
		'data-toggle': 'popover', 
		'data-placement': 'right', 
		'data-html': 'true',
		'data-content': '<div class="box box-primary" style="width:200px;">\
										<div class="box-body box-profile">\
											<img class="profile-user-img img-responsive img-circle" src="' + data.user_img + '" alt="User profile picture">\
											<h3 class="profile-username text-center">' + data.user_name + '</h3>\
											<ul class="list-group list-group-unbordered">\
												<li class="list-group-item">\
													<b>动态</b> <a class="pull-right">' + data.user_blogs + '</a>\
												</li>\
												<li class="list-group-item">\
													<b>精华</b> <a class="pull-right">' + data.user_bestblogs + '</a>\
												</li>\
												<li class="list-group-item">\
													<b>关注者</b> <a class="pull-right">' + data.user_followers +'</a>\
												</li>\
											</ul>\
											<a href="#" class="btn btn-primary btn-block follow-btn" value="' + data.user_id + '"><b>关注</b></a>\
										</div>\
									</div>'
	});							
};
<!-- wysiwyg -->
var loadWysiwyg = function(target){
	$(function(){
	function initToolbarBootstrapBindings() {
		var fonts = ['Serif', 'Sans', 'Arial', 'Arial Black', 'Courier', 
			'Courier New', 'Comic Sans MS', 'Helvetica', 'Impact', 'Lucida Grande', 'Lucida Sans', 'Tahoma', 'Times',
			'Times New Roman', 'Verdana','SimHei'],
			fontTarget = $('[title=字体]').siblings('.dropdown-menu');
		$.each(fonts, function (idx, fontName) {
			fontTarget.append($('<li><a data-edit="fontName ' + fontName +'" style="font-family:\''+ fontName +'\'">'+fontName + '</a></li>'));
		});
		$('a[title]').tooltip({container:'body'});
		$('.dropdown-menu input').click(function() {return false;})
			.change(function () {$(this).parent('.dropdown-menu').siblings('.dropdown-toggle').dropdown('toggle');})
		.keydown('esc', function () {this.value='';$(this).change();});

		$('[data-role=magic-overlay]').each(function () { 
		var overlay = $(this), target = $(overlay.data('target')); 
		overlay.css('opacity', 0).css('position', 'absolute').offset(target.offset()).width(target.outerWidth()).height(target.outerHeight());
		});
		/*
		if ("onwebkitspeechchange"  in document.createElement("input")) {
		var editorOffset = $('#editor').offset();
		$('#voiceBtn').css('position','absolute').offset({top: editorOffset.top, left: editorOffset.left+$('#editor').innerWidth()-35});
		} else {
		$('#voiceBtn').hide();
		}
		*/
	};
	function showErrorAlert (reason, detail) {
		var msg='';
		if (reason==='unsupported-file-type') { msg = "Unsupported format " +detail; }
		else {
			console.log("error uploading file", reason, detail);
		}
		$('<div class="alert"> <button type="button" class="close" data-dismiss="alert">&times;</button>'+ 
		 '<strong>File upload error</strong> '+msg+' </div>').prependTo('#alerts');
	};
	initToolbarBootstrapBindings();  
	$(target).wysiwyg({ fileUploadError: showErrorAlert} );
	window.prettyPrint && prettyPrint();
	});
	
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','http://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-37452180-6', 'github.io');
	ga('send', 'pageview');
	(function(d, s, id) {
	var js, fjs = d.getElementsByTagName(s)[0];
	if (d.getElementById(id)) return;
	js = d.createElement(s); js.id = id;
	js.src = "http://connect.facebook.net/en_GB/all.js#xfbml=1";
	fjs.parentNode.insertBefore(js, fjs);
	}(document, 'script', 'facebook-jssdk'));
	!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="http://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
};
<!-- End of wysiwyg -->

//辅助方法
var getDate_Trans = function(datetime){
	return "2015年10月23号";
};
var getTime_Trans = function(datetime){
	return "09:18";
};
var colors = ['label-danger', 'label-success', 'label-info', 'label-warning', 'label-primary'];
var randomPicker = function(array){
	var random = Math.floor(Math.random() * (array.length));
	return array[random];
}
</script>
<!-- <li><a href="#tab_moment" data-toggle="tab" data-filter="{star:1}"><i class="fa fa-list-alt"></i> <span>星标动态</span></a></li> -->
<script>
	$('a[data-toggle="tab"][href="#tab_moment"]').on('shown.bs.tab', function (e) {
		var filter = {};
		if($(e.target).attr('data-filter')){
			filter = $.parseJSON($(e.target).attr('data-filter'));
		}
		//console.log(filter);
		initialMomentPostBlock('#postmoment');
		$('#tab_moment .moment-content').empty();
		$.get(ACTION_MAP.getRelatedMoment, filter, function(data){
			loadMoment(data, '#tab_moment .moment-content');
		}).fail(function() {
			console.log('Err: 加载动态失败');
		});
		
	});
	
	$('a[data-toggle="tab"][href="#tab_customerhome"]').on('shown.bs.tab', function (e) {
		$.get(ACTION_MAP.getUserInfobyID, {}, function(data){
				loadUserInfo(data, '#tab_customerhome');
		}).fail(function() {
			console.log('Err: tag');
		});
	});
	
	$('#tab_customerhome .nav-tabs a[data-toggle="tab"][href="#tab_1"]').on('shown.bs.tab', function (e){
		$('#tab_customerhome #tab_1 .timeline').empty();
		$.get(ACTION_MAP.getMomentByUserID, {uid: $('#tab_customerhome .nav-tabs-custom').attr('data-uid')}, function(data){
			loadMoment(data,'#tab_1 .timeline');
		}).fail(function(){
			console.log("err");
		});
		
	});
	$('#tab_customerhome .nav-tabs a[data-toggle="tab"][href="#tab_2"]').on('shown.bs.tab', function (e){
		if($(this).attr('data-type') == 'following'){
			$.get(ACTION_MAP.getFollowing, $.parseJSON($(e.target).attr('data-filter')), function(data){
				loadFollowList(data, '#tab_customerhome #tab_2');
			}).fail(function(){
				console.log("err");
			});
		}else if($(this).attr('data-type') == 'followed'){
			$.get(ACTION_MAP.getFollowed, function(data){
				loadFollowList(data, '#tab_customerhome #tab_2');
			}).fail(function(){
				console.log("err");
			});
		}
		//$('#tab_customerhome #tab_2').empty();
		//alert(2);
	});
	$('a[data-toggle="tab"][href="#tab_moment"]:eq(0)').tab('show');
	
	
</script>
<!-- <div class="nav-tabs-custom">
<ul class="nav nav-tabs">
	<li class="active"><a href="#tab_1" data-toggle="tab">动态 <span data-type="moment-count" style="color: #bdbdbd"> 4</span></a></li>
	<li class="dropdown">
		<a class="dropdown-toggle" data-toggle="dropdown" href="#">
			关注 <span class="caret"></span>
		</a>
		<ul class="dropdown-menu">
			<li><a href="#tab_2" data-toggle="tab" tabindex="-1">关注的人 <span data-type="following-individual" style="color: #bdbdbd"> 4</span></a></li>
			<li><a href="#tab_2" data-toggle="tab" tabindex="-1">关注的群组 <span data-type="following-group" style="color: #bdbdbd"> 4</span></a></li>
			<li class="divider"></li>
			<li><a href="#tab_2" data-toggle="tab" tabindex="-1">关注我的人 <span data-type="followed-by" style="color: #bdbdbd"> 4</span></a></li>
		</ul>
	</li>
</ul>
<div class="tab-content">
	<div class="tab-pane" id="tab_1">
		
	</div>
	<div class="tab-pane active" id="tab_2">
		
	</div>
</div>
</div> -->
<style>
.modal {
	text-align: center;
	padding: 0!important;
}

.modal:before {
	content: '';
	display: inline-block;
	height: 100%;
	vertical-align: middle;
	margin-right: -4px;
}

.modal-dialog {
	display: inline-block;
	text-align: left;
	vertical-align: middle;
}
/* wysiwyg */
.editor {
	min-height: 100px;
	background-color: white;
	border-collapse: separate; 
	border: 1px solid rgb(204, 204, 204); 
	padding: 4px; 
	box-sizing: content-box; 
	-webkit-box-shadow: rgba(0, 0, 0, 0.0745098) 0px 1px 1px 0px inset; 
	box-shadow: rgba(0, 0, 0, 0.0745098) 0px 1px 1px 0px inset;
	border-top-right-radius: 3px; border-bottom-right-radius: 3px;
	border-bottom-left-radius: 3px; border-top-left-radius: 3px;
	overflow-y: scroll;
	outline: none;
	-webkit-transition: min-height 2s; /* Safari */
	transition: min-height 1s;
}
.editor:focus {
	min-height: 200px;
}

div[data-role="editor-toolbar"] {
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}

.dropdown-menu a {
	cursor: pointer;
}
/* end of wysiwyg */

.moment {
	
}
.moment-fold {
	height: 150px;
	overflow-y: hidden;
}
#momentModal img, .moment img {
	max-width: 500px;
};
.reply {
	
}
.reply-fold {
	height:150px;
	overflow-y:hidden;
}
.reply img {
	max-width: 500px;
};
#momentModal img {
	max-width: 500px;
};
</style>
</body>
</html>
